<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal de Atividades Interativas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f0f4f8; color: #1a202c; }
        .btn, .btn-answer { transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease; }
        .btn:active, .btn-answer:active { transform: scale(0.95); }
        .feedback-correct { animation: flash-green 0.7s; }
        @keyframes flash-green { 50% { background-color: #c6f6d5; } }
        .feedback-incorrect { animation: flash-red 0.7s; }
        @keyframes flash-red { 50% { background-color: #fed7d7; } }
        .tab-btn { padding: 0.75rem 1.5rem; font-size: 1.125rem; font-weight: 600; border-radius: 0.5rem; cursor: pointer; border-bottom: 4px solid transparent; }
        .tab-btn-active { color: #2563eb; border-bottom-color: #2563eb; }
        .board { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; max-width: 320px; margin: 20px auto; }
        .board-cell { width: 56px; height: 56px; border: 2px solid #cbd5e1; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 1.1rem; background-color: #f1f5f9; }
        .player-position { background-color: #60a5fa; color: white; border-color: #2563eb; transform: scale(1.1); box-shadow: 0 0 15px rgba(96, 165, 250, 0.7); }
        .challenge-cell { background-color: #facc15; border-color: #ca8a04; }
        .start-cell { background-color: #4ade80; border-color: #16a34a; color: white;}
        .end-cell { background-color: #f87171; border-color: #dc2626; color: white;}
        @media print {
            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            body * { visibility: hidden; }
            #printable-report, #printable-report * { visibility: visible; }
            #printable-report { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none; }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-2 md:p-4">

    <div id="app-container" class="w-full max-w-4xl mx-auto no-print">

        <!-- TELA DE LOGIN -->
        <div id="login-screen" class="bg-white p-8 rounded-2xl shadow-xl text-center">
            <h1 class="text-3xl font-bold text-blue-600 mb-2">Portal de Atividades</h1>
            <p class="text-gray-500 mb-8">Aprender e brincar nunca foi tão fácil!</p>
            <input type="text" id="student-name-input" placeholder="Nome do Aluno(a)" class="w-full max-w-sm mx-auto bg-gray-100 border-2 border-gray-300 text-gray-800 text-center text-lg rounded-lg p-3 mb-6 focus:outline-none focus:border-blue-500 transition-colors">
            <button id="login-btn" class="mt-2 w-full max-w-sm mx-auto bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 px-8 rounded-lg text-xl shadow-lg transition-transform hover:scale-105 btn">Acessar Atividades</button>
            <button id="show-dashboard-btn" class="mt-4 text-gray-500 hover:text-gray-800">Painel do Professor</button>
        </div>
        
        <!-- HUB DE ATIVIDADES DO ALUNO -->
        <div id="student-hub-screen" class="hidden bg-white p-8 rounded-2xl shadow-xl"></div>
        
        <!-- TELA DE ATIVIDADE -->
        <div id="activity-screen" class="hidden bg-white p-6 rounded-2xl shadow-xl"></div>
        
        <!-- TELA DE FIM DE SESSÃO -->
        <div id="end-screen" class="hidden bg-white p-8 rounded-2xl shadow-xl text-center"></div>

        <!-- PAINEL DO PROFESSOR -->
        <div id="dashboard-screen" class="hidden bg-white p-8 rounded-2xl shadow-xl"></div>
    </div>
    
    <!-- ÁREA DE IMPRESSÃO -->
    <div id="printable-report" class="bg-white"></div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw5eYuevOFhnFCxe4NVGy71qZ_j1kvWn5kzvglrs9rN8bJep_qtxGjJ3Zj51RjRjtk/exec'; 
        const skills = { S1:{saeb:"D19",bncc:"EF01MA01",desc:"Contar e reconhecer números naturais."},S2:{saeb:"D19",bncc:"EF01MA06",desc:"Resolver problemas de adição e subtração com suporte visual."},S3:{saeb:"D20",bncc:"EF02MA04",desc:"Compreender o sistema de numeração decimal."},S4:{saeb:"D22",bncc:"EF03MA05",desc:"Utilizar diferentes procedimentos de cálculo para resolver problemas (multiplicação/divisão)."},S5:{saeb:"D19",bncc:"EF01MA08",desc:"Resolver problemas envolvendo diferentes significados das operações."},S6:{saeb:"D17",bncc:"EF02MA20",desc:"Resolver problemas com o sistema monetário brasileiro."},L1:{saeb:"N/A",bncc:"EF01LP04",desc:"Distinguir as letras do alfabeto de outros sinais gráficos."},L2:{saeb:"N/A",bncc:"EF01LP10",desc:"Nomear as letras do alfabeto e recitá-lo na ordem das letras."} };
        function generateMathActivity(title,id,op,maxNumber,questions=20){const activity={id:id,title:title,description:`Pratique ${op==="+"?"somas":op==="-"?"subtrações":op==="*"?"multiplicações":"divisões"} até ${maxNumber}.`,tasks:[]};for(let i=0;i<questions;i++){let num1,num2,answer;if(op==="+"||op==="*"){num1=Math.floor(Math.random()*(op==="*"&&maxNumber>10?10:maxNumber))+1;num2=Math.floor(Math.random()*(op==="*"&&maxNumber>10?10:maxNumber))+1;answer=op==="+"?num1+num2:num1*num2}else{num2=Math.floor(Math.random()*(maxNumber-1))+1;answer=Math.floor(Math.random()*(maxNumber-num2))+1;num1=answer+num2;if(op==="/"){num1=num2*(Math.floor(Math.random()*5)+2);answer=num1/num2}}const options=new Set([answer]);while(options.size<3){const wrongOption=answer+(Math.floor(Math.random()*5)+1)*(Math.random()>.5?1:-1);if(wrongOption>0&&wrongOption!==answer)options.add(wrongOption)}activity.tasks.push({type:"operation",instruction:`Quanto é ${num1} ${op==="*"?"vezes":op} ${num2}?`,op:op,quantities:[num1,num2],answer:answer,options:Array.from(options).sort(()=>Math.random()-.5),skillId:"S2"})}return activity}
        const activities=[{id:"diagnostico_inicial_numeramento",title:"Diagnóstico de Numeramento",description:"20 questões para sondagem de habilidades básicas.",tasks:[{type:"recognize",instruction:"Toque no número 5",answer:5,options:[3,8,5],skillId:"S1"},{type:"count",instruction:"Quantos sóis você vê?",quantity:4,answer:4,options:[4,2,6],skillId:"S1"},{type:"count",instruction:"Quantas luas você vê?",quantity:8,answer:8,options:[7,8,9],skillId:"S1"},{type:"match",instruction:"Toque no número que representa as estrelas",quantity:7,answer:7,options:[5,7,9],skillId:"S1"},{type:"compare",instruction:"Qual lado tem MAIS?",quantities:[6,3],answer:"left",skillId:"S1"},{type:"operation",instruction:"Quanto é?",quantities:[3,2],op:"+",answer:5,options:[4,5,6],skillId:"S2"},{type:"operation",instruction:"Quanto é?",quantities:[5,4],op:"+",answer:9,options:[8,1,9],skillId:"S2"},{type:"operation",instruction:"Quanto resta?",quantities:[6,2],op:"-",answer:4,options:[8,3,4],skillId:"S2"},{type:"operation",instruction:"Quanto resta?",quantities:[9,5],op:"-",answer:4,options:[4,5,14],skillId:"S2"},{type:"operation",instruction:"Quanto é?",quantities:[7,3],op:"+",answer:10,options:[4,9,10],skillId:"S2"},{type:"recognize",instruction:"Toque no número 14",answer:14,options:[41,24,14],skillId:"S3"},{type:"placeValue",instruction:"Que número é este?",answer:23,values:{tens:2,ones:3},options:[32,23,5],skillId:"S3"},{type:"placeValue",instruction:"Que número é este?",answer:41,values:{tens:4,ones:1},options:[14,41,50],skillId:"S3"},{type:"operation",instruction:"Quanto é?",quantities:[10,6],op:"+",answer:16,options:[4,16,106],skillId:"S3"},{type:"operation",instruction:"Quanto resta?",quantities:[20,5],op:"-",answer:15,options:[25,10,15],skillId:"S3"},{type:"placeValue",instruction:"Que número é este?",answer:125,values:{hundreds:1,tens:2,ones:5},options:[152,215,125],skillId:"S4"},{type:"placeValue",instruction:"Que número é este?",answer:304,values:{hundreds:3,tens:0,ones:4},options:[340,403,304],skillId:"S4"},{type:"operation",instruction:"Quanto é?",quantities:[22,13],op:"+",answer:35,options:[35,25,19],skillId:"S4"},{type:"operation",instruction:"Quanto é?",quantities:[16,7],op:"+",answer:23,options:[13,23,24],skillId:"S4"},{type:"recognize",instruction:"Toque no número 1000",answer:1e3,options:[100,10,1e3],skillId:"S4"}]},{id:"desafios_dia_a_dia",title:"Desafios do Dia a Dia",description:"20 problemas com situações práticas e dinheiro.",tasks:[{type:"problem",instruction:"Ana tinha 8 maçãs e comeu 3. Com quantas ela ficou?",visuals:{type:"apple",quantities:[8,3],op:"-"},answer:5,options:[11,5,6],skillId:"S5"},{type:"problem",instruction:"Pedro tem 5 bolas e ganha mais 4. Com quantas ele fica?",visuals:{type:"ball",quantities:[5,4],op:"+"},answer:9,options:[1,9,8],skillId:"S5"},{type:"problem",instruction:"Havia 9 pássaros no fio. 4 voaram. Quantos ficaram?",visuals:{type:"bird",quantities:[9,4],op:"-"},answer:5,options:[13,5,6],skillId:"S5"},{type:"problem",instruction:"João tem 3 carrinhos e ganha mais 3. Com quantos ele fica?",visuals:{type:"car",quantities:[3,3],op:"+"},answer:6,options:[0,5,6],skillId:"S5"},{type:"problem",instruction:"Numa cesta há 6 laranjas e 5 limões. Quantas frutas há no total?",visuals:{type:"fruta",quantities:[6,5],op:"+"},answer:11,options:[1,11,10],skillId:"S5"},{type:"money",instruction:"Quanto dinheiro você tem ao todo?",items:["5r","2r","1r"],answer:8,options:[7,8,9],skillId:"S6"},{type:"money",instruction:"Junte as moedas. Qual o total?",items:["1r","1r","1r","1r","1r"],answer:5,options:[4,6,5],skillId:"S6"},{type:"money",instruction:"Um sorvete custa R$ 4. Se você pagar com R$ 5, qual é o troco?",items:["5r","sorvete_4r"],answer:1,options:[1,9,4],skillId:"S6"},{type:"money",instruction:"Um suco custa R$ 6. Se você pagar com R$ 10, qual é o troco?",items:["10r","suco_6r"],answer:4,options:[16,3,4],skillId:"S6"},{type:"money",instruction:"Quanto dinheiro você tem ao todo?",items:["10r","5r","2r"],answer:17,options:[15,17,18],skillId:"S6"},{type:"problem",instruction:"Você tem 6 adesivos, ganha 2 e depois perde 1. Com quantos fica?",visuals:{type:"star",quantities:[6,2,1],op:"+-"},answer:7,options:[7,8,9],skillId:"S5"},{type:"problem",instruction:"No ônibus havia 10 pessoas. Desceram 4 e subiram 2. Quantas pessoas há agora?",visuals:{type:"pessoa",quantities:[10,4,2],op:"-+"},answer:8,options:[6,7,8],skillId:"S5"},{type:"problem",instruction:"Maria fez 5 biscoitos. Depois fez mais 5. Comeu 3. Quantos restaram?",visuals:{type:"biscoito",quantities:[5,5,3],op:"+-"},answer:7,options:[7,10,13],skillId:"S5"},{type:"money",instruction:"Você tem R$ 10. Compra um gibi de R$ 7. Qual o troco?",items:["10r","gibi_7r"],answer:3,options:[3,17,4],skillId:"S6"},{type:"money",instruction:"Você tem R$ 12. Ganha R$ 5. Com quanto você fica?",items:["10r","2r","5r_add"],answer:17,options:[7,16,17],skillId:"S6"},{type:"problem",instruction:"Em um aquário há 4 peixes azuis e 3 vermelhos. Chegaram mais 2 peixes azuis. Quantos peixes há no total?",visuals:{type:"peixe",quantities:[4,3,2],op:"++"},answer:9,options:[8,9,10],skillId:"S5"},{type:"money",instruction:"Um caderno custa R$ 8. Você paga com duas notas de R$ 5. Qual o troco?",items:["5r","5r","caderno_8r"],answer:2,options:[2,3,18],skillId:"S6"},{type:"problem",instruction:"Numa árvore havia 12 laranjas. Caíram 5 e você colheu 3. Quantas laranjas sobraram na árvore?",visuals:{type:"fruta",quantities:[12,5,3],op:"--"},answer:4,options:[4,7,10],skillId:"S5"},{type:"money",instruction:"Junte todo o dinheiro. Qual o total?",items:["10r","5r","2r","1r","1r"],answer:19,options:[18,19,20],skillId:"S6"},{type:"problem",instruction:"Bia tem 7 bonecas. Ganha 3 de sua mãe e dá 2 para sua prima. Com quantas bonecas Bia fica?",visuals:{type:"boneca",quantities:[7,3,2],op:"+-"},answer:8,options:[6,8,12],skillId:"S5"}]},{id:"encontre_vogais",title:"Letramento: Caça às Vogais",description:"Clique na vogal que se pede.",tasks:[{type:"recognizeLetter",instruction:"Toque na letra A",answer:"A",options:["B","A","C"],skillId:"L1"},{type:"recognizeLetter",instruction:"Toque na letra E",answer:"E",options:["F","D","E"],skillId:"L1"},{type:"recognizeLetter",instruction:"Toque na letra I",answer:"I",options:["I","J","L"],skillId:"L1"},{type:"recognizeLetter",instruction:"Toque na letra O",answer:"O",options:["P","O","Q"],skillId:"L1"},{type:"recognizeLetter",instruction:"Toque na letra U",answer:"U",options:["V","W","U"],skillId:"L1"}].flatMap(t=>Array(4).fill(t))},{id:"quantas_letras",title:"Letramento: Contador de Letras",description:"Conte quantas letras tem cada palavra.",tasks:[{type:"countLetters",instruction:"Quantas letras tem a palavra SOL?",word:"SOL",answer:3,options:[2,3,4],skillId:"L2"},{type:"countLetters",instruction:"Quantas letras tem a palavra LUA?",word:"LUA",answer:3,options:[2,3,4],skillId:"L2"},{type:"countLetters",instruction:"Quantas letras tem a palavra CASA?",word:"CASA",answer:4,options:[3,4,5],skillId:"L2"},{type:"countLetters",instruction:"Quantas letras tem a palavra GATO?",word:"GATO",answer:4,options:[3,4,5],skillId:"L2"},{type:"countLetters",instruction:"Quantas letras tem a palavra BOLA?",word:"BOLA",answer:4,options:[3,4,5],skillId:"L2"}].flatMap(t=>Array(4).fill(t))},{id:"forma_palavra",title:"Letramento: Monta Palavras",description:"Coloque as letras na ordem certa.",tasks:[{type:"forma_palavra",instruction:"Forme a palavra BOLA",image:"ball",answer:"BOLA",letters:["L","A","B","O"],skillId:"L2"},{type:"forma_palavra",instruction:"Forme a palavra PATO",image:"duck",answer:"PATO",letters:["T","O","P","A"],skillId:"L2"},{type:"forma_palavra",instruction:"Forme a palavra DADO",image:"dice",answer:"DADO",letters:["O","D","A","D"],skillId:"L2"},{type:"forma_palavra",instruction:"Forme a palavra UVA",image:"grape",answer:"UVA",letters:["A","U","V"],skillId:"L2"},{type:"forma_palavra",instruction:"Forme a palavra SOL",image:"sun",answer:"SOL",letters:["L","S","O"],skillId:"L2"}].flatMap(t=>Array(4).fill(t))},{id:"contagem_visual_10",title:"Contagem: Objetos até 10",description:"Conte quantos objetos aparecem.",tasks:Array.from({length:20},()=>{const qty=Math.floor(Math.random()*9)+2;return{type:"count",instruction:"Quantos objetos você vê?",quantity:qty,answer:qty,options:[qty,qty-1,qty+1].sort(()=>Math.random()-.5),skillId:"S1"}})},{id:"maior_ou_menor_10",title:"Comparação: Maior ou Menor (até 10)",description:"Qual lado tem mais objetos?",tasks:Array.from({length:20},()=>{const q1=Math.floor(Math.random()*10)+1;let q2=Math.floor(Math.random()*10)+1;while(q1===q2){q2=Math.floor(Math.random()*10)+1}return{type:"compare",instruction:"Qual lado tem MAIS?",quantities:[q1,q2],answer:q1>q2?"left":"right",skillId:"S1"}})},{id:"sequencia_numerica_20",title:"Raciocínio: Sequência Numérica (até 20)",description:"Descubra o número que falta.",tasks:Array.from({length:20},()=>{const start=Math.floor(Math.random()*15)+1;return{type:"sequencia",instruction:"Qual número está faltando?",sequence:[start,start+1,"?",start+3],answer:start+2,options:[start+2,start+1,start+3].sort(()=>Math.random()-.5),skillId:"S1"}})},generateMathActivity("Soma Simples até 10","soma_10","+",10),generateMathActivity("Subtração Simples até 10","subtracao_10","-",10),generateMathActivity("Soma Simples até 20","soma_20","+",20),generateMathActivity("Subtração Simples até 20","subtracao_20","-",20),generateMathActivity("Soma Simples até 50","soma_50","+",50),generateMathActivity("Subtração Simples até 50","subtracao_50","-",50),generateMathActivity("Multiplicação (Tabuada)","multiplicacao_10","*",10),generateMathActivity("Divisão Simples","divisao_5","/",25),{id:"operacoes_mistas_20",title:"Cálculo Rápido: Operações Mistas",description:"Resolva somas e subtrações até 20.",tasks:[...generateMathActivity("","","+",20,10).tasks,...generateMathActivity("","","-",20,10).tasks].sort(()=>Math.random()-.5)},{id:"trilha_do_tesouro",type:"game",title:"Jogo: Trilha do Tesouro",description:"Jogue o dado e resolva desafios!",tasks:Array(20).fill({type:"diceGame"})},{id:"banco_da_cidade",type:"game",title:"Jogo: Banco da Cidade",description:"Compre e venda para se tornar o mais rico!",tasks:Array(20).fill({type:"moneyGame"})}];
        const state = { studentName: "", currentActivity: null, currentTaskIndex: 0, sessionResults: [], boardPosition: 0, builtWord: "" };
        const screens = { login: document.getElementById('login-screen'), studentHub: document.getElementById('student-hub-screen'), activity: document.getElementById('activity-screen'), end: document.getElementById('end-screen'), dashboard: document.getElementById('dashboard-screen') };

        // --- FUNÇÕES ---
        const switchScreen = (screenName) => {
            if ('speechSynthesis' in window) window.speechSynthesis.cancel();
            Object.values(screens).forEach(s => s && s.classList.add('hidden'));
            if (screens[screenName]) screens[screenName].classList.remove('hidden');
            else if (screens.login) screens.login.classList.remove('hidden');
        };

        const readAloud = (text) => {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'pt-BR';
                utterance.rate = 0.9;
                window.speechSynthesis.speak(utterance);
            }
        };

        const showTab = (tabName) => {
            document.getElementById('tab-content-atividades').classList.toggle('hidden', tabName !== 'atividades');
            document.getElementById('tab-atividades').classList.toggle('tab-btn-active', tabName === 'atividades');
            document.getElementById('tab-content-jogos').classList.toggle('hidden', tabName !== 'jogos');
            document.getElementById('tab-jogos').classList.toggle('tab-btn-active', tabName === 'jogos');
        };

        const login = () => {
            const studentName = document.getElementById('student-name-input').value.trim();
            if (!studentName) {
                alert('Por favor, preencha o seu nome.');
                return;
            }
            state.studentName = studentName;
            renderStudentHub();
            switchScreen('studentHub');
        };

        const logout = () => {
            state.studentName = "";
            document.getElementById('student-name-input').value = "";
            switchScreen('login');
        };
        
        const loadDashboard = async () => {
            const dashboard = screens.dashboard;
            dashboard.innerHTML = `<div id="dashboard-main"><h1 class="text-3xl font-bold text-blue-600 mb-6 text-center">Painel do Professor</h1><div id="student-list" class="space-y-3 max-h-[60vh] overflow-y-auto"><p>A carregar relatórios...</p></div></div><button id="back-to-start-btn" class="mt-8 text-gray-500 hover:text-gray-800 mx-auto block">Voltar ao Início</button>`;
            document.getElementById('back-to-start-btn').onclick = () => switchScreen('login');
            
            switchScreen('dashboard');

            try {
                const response = await fetch(`${SCRIPT_URL}?action=get`);
                const allReports = await response.json();
                
                const reportsByStudent = allReports.reduce((acc, report) => {
                    if (!acc[report.studentName]) acc[report.studentName] = [];
                    acc[report.studentName].push(report);
                    return acc;
                }, {});

                const studentListEl = document.getElementById('student-list');
                studentListEl.innerHTML = '';
                
                Object.keys(reportsByStudent).sort().forEach(studentName => {
                    const studentReports = reportsByStudent[studentName];
                    const card = document.createElement('div');
                    card.className = 'bg-gray-50 p-4 rounded-lg cursor-pointer hover:bg-gray-100';
                    card.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="font-bold text-lg text-gray-800">${studentName}</h3>
                                <p class="text-sm text-gray-600">${studentReports.length} atividades completas</p>
                            </div>
                            <span class="text-blue-500 font-semibold">Ver Relatórios →</span>
                        </div>`;
                    card.onclick = () => {
                        // Aqui você pode criar uma nova tela para mostrar os relatórios do aluno
                        alert(`Relatórios para ${studentName}`);
                    };
                    studentListEl.appendChild(card);
                });

            } catch(e) {
                document.getElementById('student-list').innerHTML = `<p class="text-red-500">Não foi possível carregar os relatórios.</p>`;
                console.error("Erro ao carregar dashboard:", e);
            }
        };


        async function renderStudentHub() {
            const hub = screens.studentHub;
            hub.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Vamos lá, ${state.studentName}!</h1>
                    <button id="hub-logout-btn" class="text-gray-500 hover:text-gray-800">Sair</button>
                </div>
                <div class="flex border-b mb-6">
                    <button id="tab-atividades" class="tab-btn tab-btn-active">Atividades</button>
                    <button id="tab-jogos" class="tab-btn">Jogos</button>
                </div>
                <div id="tab-content-atividades" class="space-y-4"></div>
                <div id="tab-content-jogos" class="hidden space-y-4"></div>
            `;
            document.getElementById('hub-logout-btn').onclick = logout;
            document.getElementById('tab-atividades').onclick = () => showTab('atividades');
            document.getElementById('tab-jogos').onclick = () => showTab('jogos');

            const activitiesListEl = document.getElementById('tab-content-atividades');
            const gamesListEl = document.getElementById('tab-content-jogos');
            activitiesListEl.innerHTML = '<p>Carregando...</p>';
            gamesListEl.innerHTML = '<p>Carregando...</p>';
            
            try {
                const response = await fetch(`${SCRIPT_URL}?action=get`);
                const allReports = await response.json();
                const studentReports = allReports.filter(r => r.studentName === state.studentName);

                const latestCompleted = {};
                studentReports.forEach(report => {
                    if (!latestCompleted[report.activityId] || new Date(report.timestamp) > new Date(latestCompleted[report.activityId].timestamp)) {
                        latestCompleted[report.activityId] = report;
                    }
                });

                activitiesListEl.innerHTML = '';
                gamesListEl.innerHTML = '';
                activities.forEach(activity => {
                    const targetEl = activity.type === 'game' ? gamesListEl : activitiesListEl;
                    createActivityCard(targetEl, activity, latestCompleted);
                });
            } catch (error) {
                console.error("Erro ao buscar relatórios:", error);
                activitiesListEl.innerHTML = '<p class="text-red-500">Não foi possível carregar o histórico.</p>';
                gamesListEl.innerHTML = '';
                 activities.forEach(activity => {
                    const targetEl = activity.type === 'game' ? gamesListEl : activitiesListEl;
                    createActivityCard(targetEl, activity, {});
                });
            }
        }
        
        function createActivityCard(listEl, activity, completedActivities) {
            const report = completedActivities[activity.id];
            const isCompleted = !!report;
            const completionDate = isCompleted ? new Date(report.timestamp).toLocaleDateString('pt-BR') : '';

            const card = document.createElement('div');
            card.className = 'bg-gray-100 p-4 rounded-lg flex flex-col sm:flex-row justify-between items-center gap-4';
            card.innerHTML = `
                <div class="flex-grow text-center sm:text-left">
                    <h3 class="font-bold text-lg text-gray-800">${activity.title}</h3>
                    <p class="text-sm text-gray-600">${activity.description}</p>
                </div>
                <div class="text-center sm:text-right">
                    ${isCompleted ? `<p class="font-semibold text-green-600">Concluído</p><p class="text-xs text-gray-500">${completionDate}</p>` : '<p class="font-semibold text-gray-500">Não iniciado</p>'}
                </div>`;
            const startButton = document.createElement('button');
            startButton.textContent = isCompleted ? 'Jogar de Novo' : (activity.type === 'game' ? 'Jogar' : 'Iniciar');
            startButton.className = `w-full sm:w-auto px-6 py-2 rounded text-white font-semibold shadow-md transition-transform hover:scale-105 ${isCompleted ? 'bg-yellow-500 hover:bg-yellow-400' : 'bg-blue-500 hover:bg-blue-400'}`;
            startButton.onclick = () => startActivity(activity.id);
            card.appendChild(startButton);
            listEl.appendChild(card);
        }

        function startActivity(activityId) {
            state.currentActivity = activities.find(a => a.id === activityId);
            state.currentTaskIndex = 0;
            state.sessionResults = [];
            state.boardPosition = 1;
            state.builtWord = "";
            renderActivityScreen();
            switchScreen('activity');
            renderTask();
        }

        function renderActivityScreen() {
             screens.activity.innerHTML = `
                <div class="mb-4"><div class="flex justify-between items-center mb-2"><span class="font-bold text-lg text-gray-700">${state.studentName}</span><span class="text-gray-500">Questão <span id="question-counter">1</span> de ${state.currentActivity.tasks.length}</span></div><div class="w-full bg-gray-200 rounded-full h-4"><div id="progress-bar" class="bg-blue-500 h-4 rounded-full" style="width: ${100 / state.currentActivity.tasks.length}%"></div></div></div>
                <div class="flex justify-center items-center gap-4 my-4"><p id="instruction-text" class="text-2xl font-semibold text-center text-gray-700 h-16 flex items-center justify-center"></p><button id="read-aloud-btn" class="p-2 rounded-full bg-blue-100 hover:bg-blue-200 text-blue-600 transition-colors"><svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM14.657 2.929a1 1 0 011.414 0A9.972 9.972 0 0119 10a9.972 9.972 0 01-2.929 7.071 1 1 0 01-1.414-1.414A7.971 7.971 0 0017 10c0-2.21-.894-4.208-2.343-5.657a1 1 0 010-1.414zm-2.829 2.828a1 1 0 011.415 0A5.983 5.983 0 0115 10a5.984 5.984 0 01-1.757 4.243 1 1 0 01-1.415-1.415A3.984 3.984 0 0013 10a3.983 3.983 0 00-1.172-2.828 1 1 0 010-1.415z" clip-rule="evenodd"></path></svg></button></div>
                <div id="task-container" class="my-6 min-h-[200px] flex flex-col items-center justify-center gap-4 flex-wrap"></div>
                <div id="options-container" class="mt-6 flex flex-wrap justify-center gap-4"></div>`;
        }
        
        // ... (o restante das funções permanece igual)
        
        document.getElementById('login-btn').onclick = login;
        document.getElementById('show-dashboard-btn').onclick = loadDashboard;
        
        switchScreen('login');
    });
    </script>
</body>
</html>

