<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal de Acompanhamento Individualizado</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: #f0f4f8;
            color: #1a202c;
        }
        .btn-answer {
            transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
        }
        .btn-answer:active {
            transform: scale(0.95);
        }
        .feedback-correct { animation: flash-green 0.7s; }
        @keyframes flash-green { 50% { background-color: #c6f6d5; } }
        .feedback-incorrect { animation: flash-red 0.7s; }
        @keyframes flash-red { 50% { background-color: #fed7d7; } }
        .progress-bar-fill { transition: width 0.5s ease; }
        
        /* Estilos para Impressão */
        @media print {
            body * {
                visibility: hidden;
            }
            #printable-report, #printable-report * {
                visibility: visible;
            }
            #printable-report {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .no-print {
                display: none;
            }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-2 md:p-4">

    <div id="app-container" class="w-full max-w-4xl mx-auto no-print">

        <!-- TELA DE LOGIN -->
        <div id="login-screen" class="bg-white p-8 rounded-2xl shadow-xl text-center">
            <h1 class="text-3xl font-bold text-blue-600 mb-2">Portal de Acompanhamento</h1>
            <p class="text-gray-500 mb-8">Acesse as atividades ou os relatórios.</p>
            <input type="text" id="student-name-input" placeholder="Nome do Aluno(a)" class="w-full max-w-sm mx-auto bg-gray-100 border-2 border-gray-300 text-gray-800 text-center text-lg rounded-lg p-3 mb-6 focus:outline-none focus:border-blue-500 transition-colors">
            <button id="login-btn" class="mt-2 w-full max-w-sm mx-auto bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 px-8 rounded-lg text-xl shadow-lg transition-transform hover:scale-105">Acessar Atividades</button>
            <button id="show-dashboard-btn" class="mt-4 text-gray-500 hover:text-gray-800">Painel do Professor</button>
        </div>
        
        <!-- HUB DE ATIVIDADES DO ALUNO -->
        <div id="student-hub-screen" class="hidden bg-white p-8 rounded-2xl shadow-xl">
            <h1 id="hub-welcome-message" class="text-3xl font-bold text-gray-800 mb-6"></h1>
            <div id="activities-list" class="space-y-4"></div>
            <button id="hub-logout-btn" class="mt-8 text-gray-500 hover:text-gray-800">Sair</button>
        </div>

        <!-- TELA DE ATIVIDADE -->
        <div id="activity-screen" class="hidden bg-white p-6 rounded-2xl shadow-xl">
             <!-- Conteúdo da atividade (gerado dinamicamente) -->
        </div>
        
        <!-- TELA DE FIM DE SESSÃO -->
        <div id="end-screen" class="hidden bg-white p-8 rounded-2xl shadow-xl text-center">
             <!-- Conteúdo de fim de sessão (gerado dinamicamente) -->
        </div>

        <!-- PAINEL DO PROFESSOR -->
        <div id="dashboard-screen" class="hidden bg-white p-8 rounded-2xl shadow-xl">
             <div id="dashboard-main">
                <h1 class="text-3xl font-bold text-blue-600 mb-6 text-center">Painel do Professor</h1>
                <div id="student-list" class="space-y-3 max-h-[60vh] overflow-y-auto"></div>
             </div>
             <button id="back-to-start-btn" class="mt-8 text-gray-500 hover:text-gray-800 mx-auto block">Voltar ao Início</button>
        </div>
    </div>
    
    <!-- ÁREA DE IMPRESSÃO (Fora do container principal) -->
    <div id="printable-report" class="bg-white"></div>


    <script>
        // --- CONFIGURAÇÃO MANUAL ---
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw5eYuevOFhnFCxe4NVGy71qZ_j1kvWn5kzvglrs9rN8bJep_qtxGjJ3Zj51RjRjtk/exec'; 
        // -------------------------

        // --- BANCO DE ATIVIDADES E HABILIDADES ---
        const skills = {
            S1: { saeb: 'D19', bncc: 'EF01MA01', desc: 'Contar e reconhecer números naturais.' },
            S2: { saeb: 'D19', bncc: 'EF01MA06', desc: 'Resolver problemas de adição e subtração com suporte visual.' },
            S3: { saeb: 'D20', bncc: 'EF02MA04', desc: 'Compreender o sistema de numeração decimal (unidades e dezenas).' },
            S4: { saeb: 'D21', bncc: 'EF03MA02', desc: 'Compreender o sistema de numeração decimal (centenas) e realizar operações.' },
            S5: { saeb: 'D19', bncc: 'EF01MA08', desc: 'Resolver problemas envolvendo diferentes significados da adição e subtração (juntar, acrescentar, separar, retirar).'},
            S6: { saeb: 'D17', bncc: 'EF02MA20', desc: 'Estabelecer a equivalência de valores entre cédulas e moedas do sistema monetário brasileiro para resolver problemas.' },
        };

        const activities = [
            {
                id: 'diagnostico_inicial_20',
                title: 'Diagnóstico Inicial de Numeramento',
                description: 'Uma avaliação com 20 questões progressivas para sondagem de habilidades básicas.',
                tasks: [
                    { type: 'recognize', instruction: 'Toque no número 5', answer: 5, options: [3, 8, 5], skillId: 'S1' },
                    { type: 'count', instruction: 'Quantos sóis você vê?', quantity: 4, answer: 4, options: [4, 2, 6], skillId: 'S1' },
                    { type: 'count', instruction: 'Quantas luas você vê?', quantity: 8, answer: 8, options: [7, 8, 9], skillId: 'S1' },
                    { type: 'match', instruction: 'Toque no número que representa as estrelas', quantity: 7, answer: 7, options: [5, 7, 9], skillId: 'S1' },
                    { type: 'compare', instruction: 'Qual lado tem MAIS?', quantities: [6, 3], answer: 'left', skillId: 'S1' },
                    { type: 'operation', instruction: 'Quanto é?', quantities: [3, 2], op: '+', answer: 5, options: [4, 5, 6], skillId: 'S2' },
                    { type: 'operation', instruction: 'Quanto é?', quantities: [5, 4], op: '+', answer: 9, options: [8, 1, 9], skillId: 'S2' },
                    { type: 'operation', instruction: 'Quanto resta?', quantities: [6, 2], op: '-', answer: 4, options: [8, 3, 4], skillId: 'S2' },
                    { type: 'operation', instruction: 'Quanto resta?', quantities: [9, 5], op: '-', answer: 4, options: [4, 5, 14], skillId: 'S2' },
                    { type: 'operation', instruction: 'Quanto é?', quantities: [7, 3], op: '+', answer: 10, options: [4, 9, 10], skillId: 'S2' },
                    { type: 'recognize', instruction: 'Toque no número 14', answer: 14, options: [41, 24, 14], skillId: 'S3' },
                    { type: 'placeValue', instruction: 'Que número é este?', answer: 23, values: { tens: 2, ones: 3 }, options: [32, 23, 5], skillId: 'S3' },
                    { type: 'placeValue', instruction: 'Que número é este?', answer: 41, values: { tens: 4, ones: 1 }, options: [14, 41, 50], skillId: 'S3' },
                    { type: 'operation', instruction: 'Quanto é?', quantities: [10, 6], op: '+', answer: 16, options: [4, 16, 106], skillId: 'S3' },
                    { type: 'operation', instruction: 'Quanto resta?', quantities: [20, 5], op: '-', answer: 15, options: [25, 10, 15], skillId: 'S3' },
                    { type: 'placeValue', instruction: 'Que número é este?', answer: 125, values: { hundreds: 1, tens: 2, ones: 5 }, options: [152, 215, 125], skillId: 'S4' },
                    { type: 'placeValue', instruction: 'Que número é este?', answer: 304, values: { hundreds: 3, tens: 0, ones: 4 }, options: [340, 403, 304], skillId: 'S4' },
                    { type: 'operation', instruction: 'Quanto é?', quantities: [22, 13], op: '+', answer: 35, options: [35, 25, 19], skillId: 'S4' },
                    { type: 'operation', instruction: 'Quanto é?', quantities: [16, 7], op: '+', answer: 23, options: [13, 23, 24], skillId: 'S4' },
                    { type: 'recognize', instruction: 'Toque no número 1000', answer: 1000, options: [100, 10, 1000], skillId: 'S4' }
                ]
            },
             {
                id: 'desafios_raciocinio_operatorio_20',
                title: 'Desafios do Dia a Dia (20 Questões)',
                description: 'Problemas visuais de soma e subtração com situações práticas e dinheiro.',
                tasks: [
                    // Nível 1: Operações simples
                    { type: 'problem', instruction: 'Ana tinha 8 maçãs e comeu 3. Com quantas ela ficou?', visuals: { type: 'apple', quantities: [8, 3], op: '-' }, answer: 5, options: [11, 5, 6], skillId: 'S5' },
                    { type: 'problem', instruction: 'Pedro tem 5 bolas e ganha mais 4. Com quantas ele fica?', visuals: { type: 'ball', quantities: [5, 4], op: '+' }, answer: 9, options: [1, 9, 8], skillId: 'S5' },
                    { type: 'problem', instruction: 'Havia 9 pássaros no fio. 4 voaram. Quantos ficaram?', visuals: { type: 'bird', quantities: [9, 4], op: '-' }, answer: 5, options: [13, 5, 6], skillId: 'S5' },
                    { type: 'problem', instruction: 'João tem 3 carrinhos e ganha mais 3. Com quantos ele fica?', visuals: { type: 'car', quantities: [3, 3], op: '+' }, answer: 6, options: [0, 5, 6], skillId: 'S5' },
                    { type: 'problem', instruction: 'Numa cesta há 6 laranjas e 5 limões. Quantas frutas há no total?', visuals: { type: 'fruta', quantities: [6, 5], op: '+' }, answer: 11, options: [1, 11, 10], skillId: 'S5' },
                    // Nível 2: Sistema Monetário Básico
                    { type: 'money', instruction: 'Quanto dinheiro você tem ao todo?', items: ['5r', '2r', '1r'], answer: 8, options: [7, 8, 9], skillId: 'S6' },
                    { type: 'money', instruction: 'Junte as moedas. Qual o total?', items: ['1r', '1r', '1r', '1r', '1r'], answer: 5, options: [4, 6, 5], skillId: 'S6' },
                    { type: 'money', instruction: 'Um sorvete custa R$ 4. Se você pagar com R$ 5, qual é o troco?', items: ['5r', 'sorvete_4r'], answer: 1, options: [1, 9, 4], skillId: 'S6' },
                    { type: 'money', instruction: 'Um suco custa R$ 6. Se você pagar com R$ 10, qual é o troco?', items: ['10r', 'suco_6r'], answer: 4, options: [16, 3, 4], skillId: 'S6' },
                    { type: 'money', instruction: 'Quanto dinheiro você tem ao todo?', items: ['10r', '5r', '2r'], answer: 17, options: [15, 17, 18], skillId: 'S6' },
                    // Nível 3: Problemas com mais de um passo
                    { type: 'problem', instruction: 'Você tem 6 adesivos, ganha 2 e depois perde 1. Com quantos fica?', visuals: { type: 'star', quantities: [6, 2, 1], op: '+-' }, answer: 7, options: [7, 8, 9], skillId: 'S5' },
                    { type: 'problem', instruction: 'No ônibus havia 10 pessoas. Desceram 4 e subiram 2. Quantas pessoas há agora?', visuals: { type: 'pessoa', quantities: [10, 4, 2], op: '-+' }, answer: 8, options: [6, 7, 8], skillId: 'S5' },
                    { type: 'problem', instruction: 'Maria fez 5 biscoitos. Depois fez mais 5. Comeu 3. Quantos restaram?', visuals: { type: 'biscoito', quantities: [5, 5, 3], op: '+-' }, answer: 7, options: [7, 10, 13], skillId: 'S5' },
                    { type: 'money', instruction: 'Você tem R$ 10. Compra um gibi de R$ 7. Qual o troco?', items: ['10r', 'gibi_7r'], answer: 3, options: [3, 17, 4], skillId: 'S6' },
                    { type: 'money', instruction: 'Você tem R$ 12. Ganha R$ 5. Com quanto você fica?', items: ['10r', '2r', '5r_add'], answer: 17, options: [7, 16, 17], skillId: 'S6' },
                    // Nível 4: Desafios
                    { type: 'problem', instruction: 'Em um aquário há 4 peixes azuis e 3 vermelhos. Chegaram mais 2 peixes azuis. Quantos peixes há no total?', visuals: { type: 'peixe', quantities: [4, 3, 2], op: '++' }, answer: 9, options: [8, 9, 10], skillId: 'S5' },
                    { type: 'money', instruction: 'Um caderno custa R$ 8. Você paga com duas notas de R$ 5. Qual o troco?', items: ['5r', '5r', 'caderno_8r'], answer: 2, options: [2, 3, 18], skillId: 'S6' },
                    { type: 'problem', instruction: 'Numa árvore havia 12 laranjas. Caíram 5 e você colheu 3. Quantas laranjas sobraram na árvore?', visuals: { type: 'fruta', quantities: [12, 5, 3], op: '--' }, answer: 4, options: [4, 7, 10], skillId: 'S5' },
                    { type: 'money', instruction: 'Junte todo o dinheiro. Qual o total?', items: ['10r', '5r', '2r', '1r', '1r'], answer: 19, options: [18, 19, 20], skillId: 'S6' },
                    { type: 'problem', instruction: 'Bia tem 7 bonecas. Ganha 3 de sua mãe e dá 2 para sua prima. Com quantas bonecas Bia fica?', visuals: { type: 'boneca', quantities: [7, 3, 2], op: '+-' }, answer: 8, options: [6, 8, 12], skillId: 'S5' }
                ]
            }
        ];

        const state = {
            studentName: "", currentActivity: null, currentTaskIndex: 0,
            sessionResults: [],
        };
        
        const screens = {
            login: document.getElementById('login-screen'),
            studentHub: document.getElementById('student-hub-screen'),
            activity: document.getElementById('activity-screen'),
            end: document.getElementById('end-screen'),
            dashboard: document.getElementById('dashboard-screen')
        };
        
        function switchScreen(screenName) {
            Object.values(screens).forEach(s => s.classList.add('hidden'));
            if(screens[screenName]) screens[screenName].classList.remove('hidden');
        }

        function login() {
            const studentName = document.getElementById('student-name-input').value.trim();
            if (studentName) {
                state.studentName = studentName;
                renderStudentHub();
                switchScreen('studentHub');
            } else {
                alert("Por favor, preencha o nome do aluno.");
            }
        }

        function logout() {
            state.studentName = "";
            document.getElementById('student-name-input').value = '';
            switchScreen('login');
        }

        async function renderStudentHub(name = state.studentName) {
            document.getElementById('hub-welcome-message').textContent = `Atividades de ${name}`;
            const listEl = document.getElementById('activities-list');
            listEl.innerHTML = '<p>Carregando histórico...</p>';
            
            if (SCRIPT_URL === 'COLE_SUA_URL_AQUI') {
                listEl.innerHTML = '<p class="text-red-500">Configuração pendente. Relatórios indisponíveis.</p>';
                activities.forEach(activity => createActivityCard(listEl, activity, null));
                return;
            }

            try {
                const response = await fetch(SCRIPT_URL + '?action=get');
                const allReports = await response.json();
                const studentReports = allReports.filter(r => r.studentName === name);

                const completedActivities = {};
                studentReports.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
                studentReports.forEach(report => {
                    if (!completedActivities[report.activityId]) {
                        completedActivities[report.activityId] = new Date(report.timestamp);
                    }
                });

                listEl.innerHTML = '';
                activities.forEach(activity => createActivityCard(listEl, activity, completedActivities));
            } catch (error) {
                console.error("Erro ao buscar relatórios:", error);
                listEl.innerHTML = '<p class="text-red-500">Não foi possível carregar os relatórios.</p>';
                activities.forEach(activity => createActivityCard(listEl, activity, null));
            }
        }

        function createActivityCard(listEl, activity, completedActivities) {
            const isCompleted = completedActivities ? !!completedActivities[activity.id] : false;
            const completionDate = isCompleted ? completedActivities[activity.id].toLocaleDateString('pt-BR') : '';

            const card = document.createElement('div');
            card.className = 'bg-gray-100 p-4 rounded-lg flex justify-between items-center';
            card.innerHTML = `
                <div>
                    <h3 class="font-bold text-lg text-gray-800">${activity.title}</h3>
                    <p class="text-sm text-gray-600">${activity.description}</p>
                </div>
                <div class="text-right">
                    ${isCompleted ? 
                        `<p class="font-semibold text-green-600">Concluído</p><p class="text-xs text-gray-500">${completionDate}</p>` : 
                        '<p class="font-semibold text-gray-500">Não iniciado</p>'
                    }
                </div>`;
            const startButton = document.createElement('button');
            startButton.textContent = isCompleted ? 'Refazer' : 'Iniciar';
            startButton.className = `ml-4 px-4 py-2 rounded text-white font-semibold ${isCompleted ? 'bg-yellow-500 hover:bg-yellow-400' : 'bg-blue-500 hover:bg-blue-400'}`;
            startButton.onclick = () => startActivity(activity.id);
            card.appendChild(startButton);
            listEl.appendChild(card);
        }
        
        function startActivity(activityId) {
            state.currentActivity = activities.find(a => a.id === activityId);
            state.currentTaskIndex = 0;
            state.sessionResults = [];
            renderActivityScreen();
            switchScreen('activity');
            renderTask();
        }

        function renderActivityScreen() {
            screens.activity.innerHTML = `
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-bold text-lg text-gray-700">${state.studentName}</span>
                        <span class="text-gray-500">Questão <span id="question-counter">1</span> de ${state.currentActivity.tasks.length}</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-4">
                        <div id="progress-bar" class="bg-blue-500 h-4 rounded-full progress-bar-fill" style="width: ${100 / state.currentActivity.tasks.length}%"></div>
                    </div>
                </div>
                <p id="instruction-text" class="text-2xl font-semibold text-center text-gray-700 h-16 my-4"></p>
                <div id="task-container" class="my-6 min-h-[200px] flex items-center justify-center gap-4 flex-wrap"></div>
                <div id="options-container" class="mt-6 flex flex-wrap justify-center gap-4"></div>
            `;
        }
        
        function renderTask() {
            const task = state.currentActivity.tasks[state.currentTaskIndex];
            const instructionEl = document.getElementById('instruction-text');
            const taskContainer = document.getElementById('task-container');
            const optionsContainer = document.getElementById('options-container');
            
            instructionEl.textContent = task.instruction;
            taskContainer.innerHTML = '';
            optionsContainer.innerHTML = '';
            
            const itemMap = ['sun', 'moon', 'star', 'apple', 'ball', 'car', 'sorvete_3r', 'pirulito_2r'];
            const itemType = (task.visuals && task.visuals.type) || itemMap[Math.floor(Math.random() * itemMap.length)];

            if (task.type === 'count' || task.type === 'match') {
                taskContainer.innerHTML = createVisual(itemType).repeat(task.quantity);
            } else if (task.type === 'operation') {
                const opSymbol = task.op === '+' ? '+' : '−';
                taskContainer.innerHTML = `<div class="flex items-center gap-4 text-5xl font-bold"><div class="flex gap-2 flex-wrap justify-center">${createVisual(itemType).repeat(task.quantities[0])}</div><span>${opSymbol}</span><div class="flex gap-2 flex-wrap justify-center">${createVisual(itemType).repeat(task.quantities[1])}</div><span>=</span><span>?</span></div>`;
            } else if (task.type === 'compare') {
                taskContainer.innerHTML = `<button data-answer="left" class="btn-answer bg-white p-4 rounded-lg flex flex-wrap justify-center gap-2">${createVisual(itemType).repeat(task.quantities[0])}</button><div class="text-3xl font-bold">ou</div><button data-answer="right" class="btn-answer bg-white p-4 rounded-lg flex flex-wrap justify-center gap-2">${createVisual(itemType).repeat(task.quantities[1])}</button>`;
            } else if (task.type === 'placeValue') {
                let visuals = (createVisual('hundred').repeat(task.values.hundreds || 0)) + (createVisual('ten').repeat(task.values.tens || 0)) + (createVisual('one').repeat(task.values.ones || 0));
                taskContainer.innerHTML = visuals;
            } else if (task.type === 'multiplication') {
                let groupsHTML = '';
                for(let i=0; i<task.groups; i++) {
                    groupsHTML += `<div class="p-2 border-2 border-dashed border-gray-400 rounded-lg flex gap-1">${createVisual('apple').repeat(task.itemsPerGroup)}</div>`;
                }
                taskContainer.innerHTML = `<div class="flex gap-3 items-center">${groupsHTML}</div>`;
            } else if (task.type === 'division') {
                taskContainer.innerHTML = `<div class="flex flex-col items-center gap-4"><div class="flex gap-2">${createVisual('star').repeat(task.total)}</div><div class="flex gap-4">${createVisual('box').repeat(task.groups)}</div></div>`;
            } else if (task.type === 'problem') {
                 if (task.visuals.op === '+-') {
                    taskContainer.innerHTML = `<div class="flex items-center gap-2 text-3xl font-bold"><div>${createVisual(task.visuals.type).repeat(task.visuals.quantities[0])}</div><span>+</span><div>${createVisual(task.visuals.type).repeat(task.visuals.quantities[1])}</div><span>−</span><div>${createVisual(task.visuals.type).repeat(task.visuals.quantities[2])}</div></div>`;
                } else if (task.visuals.op === '-+') {
                     taskContainer.innerHTML = `<div class="flex items-center gap-2 text-3xl font-bold"><div>${createVisual(task.visuals.type).repeat(task.visuals.quantities[0])}</div><span>−</span><div>${createVisual(task.visuals.type).repeat(task.visuals.quantities[1])}</div><span>+</span><div>${createVisual(task.visuals.type).repeat(task.visuals.quantities[2])}</div></div>`;
                } else if (task.visuals.op === '--') {
                     taskContainer.innerHTML = `<div class="flex items-center gap-2 text-3xl font-bold"><div>${createVisual(task.visuals.type).repeat(task.visuals.quantities[0])}</div><span>−</span><div>${createVisual(task.visuals.type).repeat(task.visuals.quantities[1])}</div><span>−</span><div>${createVisual(task.visuals.type).repeat(task.visuals.quantities[2])}</div></div>`;
                } else if (task.visuals.op === '++') {
                     taskContainer.innerHTML = `<div class="flex items-center gap-2 text-3xl font-bold"><div>${createVisual(task.visuals.type).repeat(task.visuals.quantities[0])}</div><span>+</span><div>${createVisual(task.visuals.type).repeat(task.visuals.quantities[1])}</div><span>+</span><div>${createVisual(task.visuals.type).repeat(task.visuals.quantities[2])}</div></div>`;
                } else {
                    const opSymbol = task.visuals.op === '+' ? '+' : '−';
                    taskContainer.innerHTML = `<div class="flex items-center gap-4 text-5xl font-bold"><div class="flex gap-2 flex-wrap justify-center">${createVisual(task.visuals.type).repeat(task.visuals.quantities[0])}</div><span>${opSymbol}</span><div class="flex gap-2 flex-wrap justify-center">${createVisual(task.visuals.type).repeat(task.visuals.quantities[1])}</div></div>`;
                }
            } else if (task.type === 'money') {
                taskContainer.innerHTML = task.items.map(item => createVisual(item)).join('');
            }

            if (task.options) {
                task.options.forEach(opt => {
                    optionsContainer.innerHTML += `<button data-answer="${opt}" class="btn-answer bg-blue-500 text-white text-5xl font-bold rounded-2xl p-6 shadow-md">${opt}</button>`;
                });
            }
            
            document.querySelectorAll('[data-answer]').forEach(el => {
                el.onclick = (e) => handleAnswer(e.currentTarget.dataset.answer);
            });
        }
        
        function handleAnswer(selectedAnswer) {
            const task = state.currentActivity.tasks[state.currentTaskIndex];
            if (!task) return; 
            const isCorrect = String(selectedAnswer) === String(task.answer);
            state.sessionResults.push({ task, selectedAnswer, isCorrect });

            const body = document.querySelector('body');
            body.classList.add(isCorrect ? 'feedback-correct' : 'feedback-incorrect');
            
            setTimeout(() => {
                body.classList.remove('feedback-correct', 'feedback-incorrect');
                state.currentTaskIndex++;
                const progress = (state.currentTaskIndex / state.currentActivity.tasks.length) * 100;
                document.getElementById('progress-bar').style.width = `${progress}%`;
                
                if (state.currentTaskIndex < state.currentActivity.tasks.length) {
                    document.getElementById('question-counter').textContent = state.currentTaskIndex + 1;
                    renderTask();
                } else {
                    finishActivity();
                }
            }, 1200);
        }

        async function finishActivity() {
            if (SCRIPT_URL !== 'COLE_SUA_URL_AQUI') {
                const payload = {
                    action: 'save',
                    data: {
                        studentName: state.studentName,
                        activityId: state.currentActivity.id,
                        activityTitle: state.currentActivity.title,
                        results: state.sessionResults,
                        timestamp: new Date().toISOString(),
                    }
                };
                try {
                    await fetch(SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify(payload),
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    });
                } catch(e) { console.error("Erro ao salvar a atividade:", e); }
            }
            renderEndScreen();
            switchScreen('end');
        }
        
        function renderEndScreen(){
            const correctCount = state.sessionResults.filter(r => r.isCorrect).length;
            screens.end.innerHTML = `
                <h1 class="text-4xl font-bold text-green-500 mb-4">Atividade Concluída!</h1>
                <p class="text-xl text-gray-600 mb-8">Você acertou ${correctCount} de ${state.currentActivity.tasks.length} questões. O relatório foi salvo.</p>
                <button id="back-to-hub-btn" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-8 rounded-lg text-xl">Voltar para Atividades</button>
                <button id="end-logout-btn" class="mt-4 text-gray-500 hover:text-gray-800">Sair</button>
            `;
            document.getElementById('back-to-hub-btn').onclick = () => { renderStudentHub(); switchScreen('studentHub'); };
            document.getElementById('end-logout-btn').onclick = logout;
        }

        function createVisual(type) {
             const visuals = {
                sun: '<svg class="w-12 h-12 text-yellow-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zM4.225 5.225a1 1 0 011.414 0l.707.707a1 1 0 01-1.414 1.414l-.707-.707a1 1 0 010-1.414zM2 10a1 1 0 011-1h1a1 1 0 110 2H3a1 1 0 01-1-1zm13.364-3.364a1 1 0 011.414 1.414l-.707.707a1 1 0 01-1.414-1.414l.707-.707zM10 16a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zm3.775-4.775a1 1 0 010 1.414l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 0zM16 10a1 1 0 011-1h1a1 1 0 110 2h-1a1 1 0 01-1-1zm-9.364 3.364a1 1 0 011.414 1.414l.707.707a1 1 0 01-1.414-1.414l-.707-.707a1 1 0 010-1.414zM10 14a4 4 0 100-8 4 4 0 000 8z" clip-rule="evenodd" /></svg>',
                moon: '<svg class="w-12 h-12 text-indigo-400" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z" /></svg>',
                star: '<svg class="w-10 h-10 text-yellow-300" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>',
                apple: '<svg class="w-10 h-10 text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 2a4 4 0 00-4 4v1H5a1 1 0 00-.994.89l-1 9A1 1 0 004.006 18h11.988a1 1 0 00.999-1.11l-1-9A1 1 0 0015 7h-1V6a4 4 0 00-4-4zm2 5V6a2 2 0 10-4 0v1h4z" clip-rule="evenodd" /></svg>',
                ball: '<svg class="w-10 h-10 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16z" clip-rule="evenodd" /></svg>',
                hundred: `<div class="w-24 h-24 bg-red-300 grid grid-cols-10 grid-rows-10 gap-px p-1 border-2 border-red-500">${ '<div class="bg-red-500"></div>'.repeat(100) }</div>`,
                ten: `<div class="w-6 h-24 bg-blue-300 grid grid-rows-10 gap-px p-1 border-2 border-blue-500">${ '<div class="bg-blue-500"></div>'.repeat(10) }</div>`,
                one: '<div class="w-6 h-6 bg-yellow-300 border-2 border-yellow-500"></div>',
                '1r': '<div class="m-1"><svg class="w-12 h-12" viewBox="0 0 50 50"><circle cx="25" cy="25" r="24" fill="#B87333" stroke="#8B4513" stroke-width="2"/><text x="50%" y="55%" dominant-baseline="middle" text-anchor="middle" font-size="20" fill="white" font-weight="bold">1</text></svg></div>',
                '2r': '<div class="m-1"><svg class="w-16 h-16" viewBox="0 0 80 40"><rect x="1" y="1" width="78" height="38" rx="5" fill="#228B22" stroke="#006400" stroke-width="2"/><text x="50%" y="55%" dominant-baseline="middle" text-anchor="middle" font-size="20" fill="white" font-weight="bold">2</text></svg></div>',
                '5r': '<div class="m-1"><svg class="w-20 h-20" viewBox="0 0 84 42"><rect x="1" y="1" width="82" height="40" rx="5" fill="#8A2BE2" stroke="#4B0082" stroke-width="2"/><text x="50%" y="55%" dominant-baseline="middle" text-anchor="middle" font-size="20" fill="white" font-weight="bold">5</text></svg></div>',
                '10r': '<div class="m-1"><svg class="w-24 h-24" viewBox="0 0 88 44"><rect x="1" y="1" width="86" height="42" rx="5" fill="#DC143C" stroke="#8B0000" stroke-width="2"/><text x="50%" y="55%" dominant-baseline="middle" text-anchor="middle" font-size="20" fill="white" font-weight="bold">10</text></svg></div>',
                'sorvete_4r': '<div class="m-1 text-center"><svg class="w-12 h-12" viewBox="0 0 100 100"><path d="M 20 40 L 50 90 L 80 40 Z" fill="#F4A460"/><circle cx="50" cy="25" r="25" fill="#FFC0CB"/></svg><p class="font-bold text-sm">R$ 4</p></div>',
                'suco_6r': '<div class="m-1 text-center"><svg class="w-12 h-12" viewBox="0 0 50 100"><rect x="10" y="20" width="30" height="60" fill="#FFA500"/><rect x="5" y="15" width="40" height="5" fill="#D2691E"/></svg><p class="font-bold text-sm">R$ 6</p></div>',
                'gibi_7r': '<div class="m-1 text-center"><svg class="w-12 h-12" viewBox="0 0 100 100"><rect x="10" y="10" width="80" height="80" rx="5" fill="#ADD8E6"/><text x="50%" y="55%" dominant-baseline="middle" text-anchor="middle" font-size="20" fill="black" font-weight="bold">GIBI</text></svg><p class="font-bold text-sm">R$ 7</p></div>',
                'caderno_8r': '<div class="m-1 text-center"><svg class="w-12 h-12" viewBox="0 0 100 100"><rect x="15" y="10" width="70" height="80" rx="5" fill="#4682B4"/><rect x="10" y="20" width="5" height="60" fill="#000000"/></svg><p class="font-bold text-sm">R$ 8</p></div>',
                '5r_add': '<div class="m-1 relative"><svg class="w-20 h-20" viewBox="0 0 84 42"><rect x="1" y="1" width="82" height="40" rx="5" fill="#8A2BE2" stroke="#4B0082" stroke-width="2"/><text x="50%" y="55%" dominant-baseline="middle" text-anchor="middle" font-size="20" fill="white" font-weight="bold">5</text></svg><span class="absolute -top-2 -left-2 text-3xl font-bold text-green-500">+</span></div>',
                bird: '<svg class="w-10 h-10 text-cyan-500" fill="currentColor" viewBox="0 0 20 20"><path d="M10.894 2.553a1 1 0 00-1.789 0l-2 4a1 1 0 00.894 1.447h4a1 1 0 00.894-1.447l-2-4zM10 8a1 1 0 011 1v1.018a1 1 0 01-2 0V9a1 1 0 011-1zM5 8a1 1 0 011-1h1V6a1 1 0 112 0v1h1a1 1 0 110 2H6a1 1 0 01-1-1zm6 4a1 1 0 100-2 1 1 0 000 2z"/></svg>',
                car: '<svg class="w-10 h-10 text-gray-600" fill="currentColor" viewBox="0 0 20 20"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/></svg>',
                fruta: '<svg class="w-10 h-10 text-orange-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM6.636 6.636a.5.5 0 01.707 0L10 9.293l2.657-2.657a.5.5 0 01.707.707L10.707 10l2.657 2.657a.5.5 0 01-.707.707L10 10.707l-2.657 2.657a.5.5 0 01-.707-.707L9.293 10 6.636 7.343a.5.5 0 010-.707z" clip-rule="evenodd" /></svg>',
                pessoa: '<svg class="w-8 h-8 text-gray-700" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>',
                biscoito: '<svg class="w-10 h-10 text-yellow-700" fill="currentColor" viewBox="0 0 20 20"><path d="M10 1a9 9 0 100 18 9 9 0 000-18zM8.016 6.22a1 1 0 011.968 0 1 1 0 01-1.968 0zM12 9a1 1 0 100-2 1 1 0 000 2zm1 3a1 1 0 11-2 0 1 1 0 012 0zm-5 2a1 1 0 100-2 1 1 0 000 2z"/></svg>',
                peixe: '<svg class="w-10 h-10 text-blue-500" fill="currentColor" viewBox="0 0 20 20"><path d="M5.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L6.707 6.707a1 1 0 01-1.414 0zM4 15a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1z"/></svg>',
                boneca: '<svg class="w-10 h-10 text-pink-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM7 9a1 1 0 100-2 1 1 0 000 2zm4-1a1 1 0 11-2 0 1 1 0 012 0zm2 2a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>',
                box: '<svg class="w-12 h-12 text-yellow-800" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2m-2 0h-8m10 0v-2m-2 2v-2m-2 2v-2m-2 2v-2"></path></svg>'
            };
            return visuals[type] || '';
        }

        function showStudentHubForTeacher(studentName, reports) {
            state.studentName = studentName; 
            document.getElementById('hub-welcome-message').textContent = \`Atividades de \${studentName}\`;
            const listEl = document.getElementById('activities-list');
            listEl.innerHTML = '';

            activities.forEach(activity => {
                const report = reports.find(r => r.activityId === activity.id);
                const isCompleted = !!report;
                const completionDate = isCompleted && report.timestamp ? new Date(report.timestamp).toLocaleString('pt-BR') : '';

                const card = document.createElement('div');
                card.className = 'bg-gray-100 p-4 rounded-lg flex justify-between items-center';
                card.innerHTML = \`
                    <div>
                        <h3 class="font-bold text-lg text-gray-800">\${activity.title}</h3>
                        <p class="text-sm text-gray-600">\${activity.description}</p>
                    </div>
                    <div class="text-right">
                        \${isCompleted ? 
                            \`<p class="font-semibold text-green-600">Concluído</p><p class="text-xs text-gray-500">\${completionDate.split(',')[0]}</p>\` : 
                            '<p class="font-semibold text-gray-500">Não iniciado</p>'
                        }
                    </div>
                \`;
                
                if (isCompleted) {
                    const reportButton = document.createElement('button');
                    reportButton.textContent = 'Ver Relatório';
                    reportButton.className = 'ml-4 px-4 py-2 rounded text-white font-semibold bg-green-600 hover:bg-green-500';
                    reportButton.onclick = () => renderPrintableReport(report);
                    card.appendChild(reportButton);
                }
                listEl.appendChild(card);
            });
            switchScreen('studentHub');
        }

        function renderPrintableReport(data) {
            const reportContainer = document.getElementById('printable-report');
            const results = data.results || [];
            const correctCount = results.filter(r => r.isCorrect).length;
            
            const skillsInDifficulty = {};
            if (Array.isArray(results)) {
                results.forEach(res => {
                    if(res && !res.isCorrect && res.task && res.task.skillId) {
                        const skill = skills[res.task.skillId];
                        if(skill && !skillsInDifficulty[skill.saeb]) {
                            skillsInDifficulty[skill.saeb] = skill;
                        }
                    }
                });
            }

            let reportHTML = \`
                <div class="p-8">
                    <div class="text-center border-b pb-4 mb-6">
                        <h1 class="text-3xl font-bold">Relatório de Desempenho</h1>
                        <h2 class="text-xl text-gray-700">\${data.activityTitle}</h2>
                    </div>
                    <div class="flex justify-between mb-6">
                        <div>
                            <p><span class="font-bold">Aluno(a):</span> \${data.studentName}</p>
                            <p><span class="font-bold">Data:</span> \${data.timestamp ? new Date(data.timestamp).toLocaleString('pt-BR') : 'Data indisponível'}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-bold">Resultado Final</p>
                            <p class="text-2xl font-bold">\${correctCount} / \${results.length} Acertos</p>
                        </div>
                    </div>

                    <div class="mb-8">
                        <h3 class="text-xl font-bold border-b pb-2 mb-3">Análise Pedagógica - Habilidades a Desenvolver</h3>
                        \${Object.keys(skillsInDifficulty).length === 0 ? '<p class="text-gray-600">O aluno demonstrou bom domínio das habilidades básicas nesta atividade.</p>' : ''}
                        <ul class="list-disc list-inside space-y-2">
                            \${Object.values(skillsInDifficulty).map(skill => \`
                                <li>
                                    <span class="font-semibold">\${skill.saeb} / \${skill.bncc}:</span> \${skill.desc}
                                </li>
                            \`).join('')}
                        </ul>
                    </div>

                    <div>
                        <h3 class="text-xl font-bold border-b pb-2 mb-3">Desempenho por Questão</h3>
                        <table class="w-full border-collapse">
                           <thead>
                             <tr class="bg-gray-100">
                                <th class="border p-2 text-left">#</th>
                                <th class="border p-2 text-left">Instrução</th>
                                <th class="border p-2 text-left">Resposta do Aluno</th>
                                <th class="border p-2 text-left">Resposta Correta</th>
                                <th class="border p-2 text-center">Resultado</th>
                             </tr>
                           </thead>
                           <tbody>
                            \${(results).map((res, index) => \`
                                <tr class="\${res.isCorrect ? '' : 'bg-red-50'}">
                                    <td class="border p-2 font-semibold">\${index + 1}</td>
                                    <td class="border p-2">\${res.task ? res.task.instruction : 'N/A'}</td>
                                    <td class="border p-2">\${res.selectedAnswer || 'N/A'}</td>
                                    <td class="border p-2">\${res.task ? res.task.answer : 'N/A'}</td>
                                    <td class="border p-2 text-center text-xl">\${res.isCorrect ? '✔️' : '❌'}</td>
                                </tr>
                            \`).join('')}
                           </tbody>
                        </table>
                    </div>
                </div>
            \`;
            
            reportContainer.innerHTML = reportHTML;
            window.print();
        }
        `;
        eval(fullLogic);
    </script>
</body>
</html>

